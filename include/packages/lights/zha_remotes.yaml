zha_remotes:
  automation:
    - alias: IKEA Remote
      id: 'ikea_remote'
      mode: restart
      trigger:
        - platform: event
          event_type: zha_event
      action:
        - service: script.zha_exec
          data_template:
            light: >-
              {% set device_light_list = {
                '90:fd:9f:ff:fe:9c:5b:fc': 'light.spisebord',
                'd0:cf:5e:ff:fe:0f:3e:9a': 'light.kaffebar',
                'd0:cf:5e:ff:fe:0d:7d:d0': 'light.kokkenbord'
              } %}
              {{ device_light_list[trigger.event.data.device_ieee] }}
            command: "{{ trigger.event.data.command }}"

  script:
    zha_exec:
      sequence:
        - service_template: >-
            {%- if command == "toggle" %}
              script.zha_5_btn_short_press_power
            {% elif command == "move_to_level_with_on_off" %}
              script.zha_5_btn_long_press_power
            {% elif 'step' in command %}
              script.zha_5_btn_short_press_dim
            {% elif 'move' in command %}
              script.zha_5_btn_long_press_dim
            {%- endif %}
          data_template:
            light: "{{ light  }}"
            dim_direction: >-
              {%- if 'step' in command %}
                {{ '-20' if command == 'step' else '20' }}
              {%- elif 'move' in command %}
                {{ '-10' if command == 'move' else '10' }}
              {% endif %}

    zha_5_btn_short_press_power:
      sequence:
        - service: light.toggle
          data_template:
            entity_id: "{{ light }}"

    zha_5_btn_short_press_dim:
      sequence:
        - service: light.turn_on
          data_template:
            entity_id: "{{ light }}"
            brightness_step_pct: "{{ dim_direction }}"
            transition: 0.5

    zha_5_btn_long_press_dim:
      sequence:
        - repeat:
            while: []
            sequence:
              - service: light.turn_on
                data_template:
                  entity_id: "{{ light }}"
                  brightness_step_pct: "{{ dim_direction }}"
                  transition: 0.5
              - delay:
                  milliseconds: 500

    zha_5_btn_long_press_power:
      sequence:
        - service: light.turn_on
          data_template:
            entity_id: "{{ light }}"
            brightness: 254